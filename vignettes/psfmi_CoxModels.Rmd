---
title: "psfmi Cox Models"
author: "Martijn W Heymans"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{psfmi_CoxModels}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

With the `psfmi` package you can pool Cox regression models by using  
the following pooling methods: RR (Rubin's Rules), D1, D2, and MPR 
(Median R Rule). You can also use forward or backward selection from
the pooled model. This vignette show you examples of how to apply these 
procedures.

# Examples 

* [Cox regression]
    + [Pooling without BW and method D1] 
    + [Pooling with BW and method MPR] 
    + [Pooling with BW including interaction terms and method D2]
    + [Pooling with BW including spline coefficient and method D1]

## Pooling without BWS and method D1

If you set p.crit at 1 than no selection of variables takes place. 
Either using direction = "FW" or direction = "BW" will produce the same
result.

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Radiation", "Onset", "Function", "Age",
  "Previous", "Tampascale", "JobControl", "JobDemand", "Social"), p.crit=1,
  cat.predictors=c("Expect_cat"), method="D1", direction = "BW")
  
  pool_coxr$RR_model
  
```  

Back to [Examples]

### Pooling with BWS and method MPR

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Radiation", "Onset", "Function", "Age",
  "Previous", "Tampascale"), p.crit=0.05,
  cat.predictors=c("Expect_cat"), method="MPR", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

### Pooling with BWS including interaction terms and method D2

Pooling Cox regression models over 5 imputed datasets with backward selection
using a p-value of 0.05 and as method D2 including interaction terms with 
a categorical predictor and forcing the predictor Tampascale in the models 
during backward selection.

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Previous",  "Radiation", "Onset",
  "Function", "Tampascale" ), p.crit=0.05, cat.predictors=c("Satisfaction",
  "Expect_cat"), int.predictors=c("Tampascale:Radiation",
  "Expect_cat:Tampascale"), keep.predictors = "Tampascale", method="D2", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

### Pooling with BWS including spline coefficients and method D1

Pooling Cox regression models over 5 imputed datasets with backward selection
using a p-value of 0.05 and as method D1 including a restricted cubic spline 
predictor and forcing Tampascale in the models during backward selection.

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Previous",  "Radiation", "Onset", "Function"), 
  p.crit=0.05, cat.predictors=c("Satisfaction"), spline.predictors=c("Tampascale"),
  int.predictors=c("Tampascale:Radiation"), keep.predictors = "Tampascale", 
  nknots=3, method="D1", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

## Stability analysis

### Stability analysis of Logistic regression model

```{r}

  library(psfmi)
  psfmi_res <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
                      predictors=c("Gender", "Smoking", "JobControl", "Age", "Duration",
                         "JobDemands", "SocialSupport"), p.crit =0.157, method="MPR",
                      cat.predictors = "Satisfaction", int.predictors = c("Gender:JobControl"),
                      direction = "BW")

   stab_res <- psfmi_stab(psfmi_res, direction="FW", start_model = TRUE,
      boot_method = "single", nboot=20, p.crit=0.05)
  stab_res$bif
  stab_res$bif_perc
  stab_res$model_stab

```  

Back to [Examples]

### Stability analysis of Cox regression model

```{r}

  library(psfmi)
  pool_lr <- psfmi_coxr(formula = Surv(Time, Status) ~ Pain + factor(Satisfaction) + rcs(Tampascale,3) +
                        Radiation + Radiation*factor(Satisfaction) + Age + Duration + Previous +
                        Radiation*rcs(Tampascale, 3), data=lbpmicox, p.crit = 0.157, direction="FW",
                        nimp=5, impvar="Impnr", keep.predictors = NULL, method="D1")
  pool_lr$RR_Model
  pool_lr$multiparm

  stab_res <- psfmi_stab(pool_lr, direction="FW", start_model = TRUE,
      boot_method = "single", nboot=20, p.crit=0.05)
  stab_res$bif
  stab_res$bif_perc
  stab_res$model_stab

```  

Back to [Examples]