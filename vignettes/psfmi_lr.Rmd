---
title: "Welcome to the psfmi package"
author: "Martijn W Heymans"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2
vignette: >
  %\VignetteIndexEntry{psfmi_lr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

On this page you will find information of the psfmi package. 
The	package contains functions to apply pooling or backward 
selection (BWS) for logistic, Cox regression and Multilevel
(Mixed models) prediction models in multiply imputed datasets. 

The basic pooling method is Rubin's Rules. For categorical predictors, 
different methods to derive pooled p-values are available as: 
the D1, D2, D3 and MPR (Median R Rule) method. Also restricted 
cubic spline coefficients can be used. Two-way interaction terms 
between continuous, dichotomous and categorical predictors are also 
possible in the model. All these type of predictors, interaction terms 
or a combination, can be forced in the model during BWS. 
Furthermore, the stability of models selected and the bootstrap inclusion 
frequency can be evaluated. For logistic and Cox regression models bootstrapping 
is than used and for Multilevel models cluster bootstrapping.

The package also contains a function to generate pooled model performance 
measures over imputed datasets as ROC/AUC, Nagelkerke R-squares, 
Brier score and calibration plots. A function to apply Bootstrap internal validation	
is also available where two methods can be used to combine bootstrapping and
multiple imputationfor internal validation. One method, boot_MI, first draws 
bootstrap samples and	subsequently performs multiple imputation and with 
the other method, MI_boot, first bootstrap samples are drawn from each imputed 
dataset before results are combined. Backward selection	as part of internal 
validation is also an option. A function with the name mivalext_lr can be 
used to externally validate prediction models in multiply imputed datasets. 
The following information of the externally validated model is provided: 
pooled ROC/AUC, (Nagelkerke) R-Square value, Hosmer and Lemeshow Test, 
pooled coefficients when the model is freely estimated in imputed datasets and 
the pooled linear predictor (LP), with information about miscalibration 
in intercept and slope. 

## Installing the psfmi package

The package can be installed from CRAN and the development version from Github 
by running the following code in the R console window:
 
 install.packages("devtools")
 
 library(devtools)
 
 devtools::install_github("mwheymans/psfmi")
 
 library(psfmi)

## Main functions

The main functions that are available in the psfmi package are:

psfmi_lr: pooling and selection of Logistic regression models in multiply imputed datasets. 

psfmi_coxr: pooling and selection of Cox regression models in multiply imputed datasets.

psfmi_mm: pooling and selection of linear and logistic Mixed models in multiply imputed datasets.

psfmi_stab: stability evaluation of models and predictors in multiply imputed datasets.

psfmi_perform: performance and internal validation of logistic regression 
models in multiply imputed datasets.

mivalext_lr: external validation in multiply imputed datasets.

## Examples 

* [Logistic Regression]
    + [Pooling without BWS and method D1] 
    + [Pooling with BWS and method D1] 
    + [Pooling with BWS including several interaction terms and method D2]
    + [Pooling with BWS and forcing interaction terms and method D1]
    + [Pooling with BWS including spline coefficient and method D1]
      
* [Cox regression]
    + [Pooling without BWS and method D1] 
    + [Pooling with BWS and method MPR] 
    + [Pooling with BWS including interaction terms and method D2]
    + [Pooling with BWS including spline coefficient and method D1]

* [Stability analysis]
    + [Stability analysis of Logistic regression model] 
    + [Stability analysis of Cox regression model]


## Logistic Regression

### Pooling without BWS and method D1

```{r}

  library(psfmi)
  pool_lr <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
  predictors=c("Gender", "Smoking", "Function", "JobControl",
  "JobDemands", "SocialSupport"), method="D1")
  
  pool_lr$RR_model
 
```

Back to [Examples]

### Pooling with BWS and method D1

Pooling Logistic regression models over 5 imputed datasets with backward selection
using a p-value of 0.05 and as method D1 and forcing the predictor "Smoking" in the 
models during backward selection.

```{r}

  library(psfmi)
  pool_lr <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
  predictors=c("Gender", "Smoking", "Function", "JobControl",
  "JobDemands", "SocialSupport"), keep.predictors = "Smoking",
  p.crit = 0.05, method="D1", direction = "BW")
  
  pool_lr$RR_model_final
  pool_lr$predictors_out
  
```

Back to [Examples]

### Pooling with BWS including several interaction terms and method D2
      
Pooling Logistic regression models over 5 imputed datasets with BWS
using a p-value of 0.05 and as method D2. Several interaction terms,
including a categorical predictor, are part of the selection procedure.

```{r}

  library(psfmi)
  pool_lr <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
  predictors=c("Gender", "Smoking", "Function", "JobControl"), 
  p.crit = 0.05, cat.predictors = c("Carrying", "Satisfaction"),
  int.predictors = c("Carrying:Smoking", "Gender:Smoking"), method="D2", direction = "BW")
  
  pool_lr$RR_model_final
  pool_lr$predictors_out
  
```

Back to [Examples]

### Pooling with BWS and forcing interaction terms and method D1
      
Same as above but now forcing several predictors, including interaction terms,
in the model during BWS.

```{r}

  library(psfmi)
  pool_lr <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
  predictors=c("Gender", "Smoking", "Function", "JobControl"), 
  p.crit = 0.05, cat.predictors = c("Carrying", "Satisfaction"),
  int.predictors = c("Carrying:Smoking", "Gender:Smoking"),
  keep.predictors = c("Smoking:Carrying", "JobControl"), method="D1", direction = "FW")
  
  pool_lr$RR_model_final
  pool_lr$predictors_in
  
```

Back to [Examples]

### Pooling with BWS including spline coefficient and method D1

Pooling Logistic regression models over 5 imputed datasets with BWS
using a p-value of 0.05 and as method D1. A spline predictor and interaction 
term are part of the selection procedure.

```{r}

  library(psfmi)
  pool_lr <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
  predictors=c("Gender", "Smoking", "JobControl"), 
  p.crit = 0.05, cat.predictors = c("Carrying", "Satisfaction"),
  spline.predictors=c("Function"), int.predictors = c("Carrying:Smoking"), 
  nknots=3, method="D1", direction = "BW")
  
  pool_lr$RR_Model
  pool_lr$predictors_out

```

Back to [Examples]

## Cox Regression

### Pooling without BWS and method D1

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Radiation", "Onset", "Function", "Age",
  "Previous", "Tampascale", "JobControl", "JobDemand", "Social"), p.crit=1,
  cat.predictors=c("Expect_cat"), method="D1", direction = "BW")
  
  pool_coxr$RR_model
  
```  

Back to [Examples]

### Pooling with BWS and method MPR

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Radiation", "Onset", "Function", "Age",
  "Previous", "Tampascale"), p.crit=0.05,
  cat.predictors=c("Expect_cat"), method="MPR", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

### Pooling with BWS including interaction terms and method D2

Pooling Cox regression models over 5 imputed datasets with backward selection
using a p-value of 0.05 and as method D2 including interaction terms with 
a categorical predictor and forcing the predictor Tampascale in the models 
during backward selection.

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Previous",  "Radiation", "Onset",
  "Function", "Tampascale" ), p.crit=0.05, cat.predictors=c("Satisfaction",
  "Expect_cat"), int.predictors=c("Tampascale:Radiation",
  "Expect_cat:Tampascale"), keep.predictors = "Tampascale", method="D2", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

### Pooling with BWS including spline coefficients and method D1

Pooling Cox regression models over 5 imputed datasets with backward selection
using a p-value of 0.05 and as method D1 including a restricted cubic spline 
predictor and forcing Tampascale in the models during backward selection.

```{r}

  library(psfmi)
  pool_coxr <- psfmi_coxr(data=lbpmicox, nimp=5, impvar="Impnr", time="Time", status="Status",
  predictors=c("Duration", "Previous",  "Radiation", "Onset", "Function"), 
  p.crit=0.05, cat.predictors=c("Satisfaction"), spline.predictors=c("Tampascale"),
  int.predictors=c("Tampascale:Radiation"), keep.predictors = "Tampascale", 
  nknots=3, method="D1", direction = "BW")
  
  pool_coxr$RR_Model
  pool_coxr$predictors_in
  
```  

Back to [Examples]

## Stability analysis

### Stability analysis of Logistic regression model

```{r}

  library(psfmi)
  psfmi_res <- psfmi_lr(data=lbpmilr, nimp=5, impvar="Impnr", Outcome="Chronic",
                      predictors=c("Gender", "Smoking", "JobControl", "Age", "Duration",
                         "JobDemands", "SocialSupport"), p.crit =0.157, method="MPR",
                      cat.predictors = "Satisfaction", int.predictors = c("Gender:JobControl"),
                      direction = "BW")

   stab_res <- psfmi_stab(psfmi_res, direction="FW", start_model = TRUE,
      boot_method = "single", nboot=20, p.crit=0.05)
  stab_res$bif
  stab_res$bif_perc
  stab_res$model_stab

```  

Back to [Examples]

### Stability analysis of Cox regression model

```{r}

  library(psfmi)
  pool_lr <- psfmi_coxr(formula = Surv(Time, Status) ~ Pain + factor(Satisfaction) + rcs(Tampascale,3) +
                        Radiation + Radiation*factor(Satisfaction) + Age + Duration + Previous +
                        Radiation*rcs(Tampascale, 3), data=lbpmicox, p.crit = 0.157, direction="FW",
                        nimp=5, impvar="Impnr", keep.predictors = NULL, method="D1")
  pool_lr$RR_Model
  pool_lr$multiparm

  stab_res <- psfmi_stab(pool_lr, direction="FW", start_model = TRUE,
      boot_method = "single", nboot=20, p.crit=0.05)
  stab_res$bif
  stab_res$bif_perc
  stab_res$model_stab

```  

Back to [Examples]